<!DOCTYPE html>
<html lang="es">
<head>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;700&display=swap" rel="stylesheet">
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Sistema de Ventas e Inventario (Offline)</title>
    <style>
        :root {
            --bg: #ffffff;
            --text: #111827;
            --muted: #6b7280;
            --card: #ffffff;
            --border: #e5e7eb;
            --accent: #7c3aed;
            --accent-soft: #ede9fe;
            --alt: #06b6d4;
            --alt-soft: #cffafe;
            --success: #16a34a;
            --danger: #dc2626;
            --warning: #d97706;
            --radius: 16px;
            --shadow: 0 8px 24px rgba(0,0,0,0.08);
            --transition: all 0.2s ease;
        }

        /* Dark mode */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #111827;
                --text: #f9fafb;
                --card: #1f2937;
                --border: #374151;
                --muted: #9ca3af;
                --accent-soft: #4c1d95;
                --alt-soft: #164e63;
            }
            body {
                background: var(--bg);
            }
            .btn.ghost {
                color: var(--text);
            }
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { font-family: 'Lexend', sans-serif; height: 100%; }
        body {
            margin: 0;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
        }

        /* Header */
        header {
            position: sticky;
            top: 0;
            z-index: 5;
            backdrop-filter: saturate(1.3) blur(6px);
            background: rgba(255,255,255,0.85);
            border-bottom: 1px solid var(--border);
        }
        .wrap { max-width: 1200px; margin: 0 auto; padding: 16px; }

        .titlebar {
            display: flex;
            gap: 16px;
            align-items: center;
            justify-content: space-between;
        }
        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 700;
            font-size: 20px;
        }
        .brand .dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), var(--alt));
            display: inline-block;
        }
        .tabs {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .tab {
            border: 1px solid var(--border);
            background: var(--card);
            padding: 10px 14px;
            border-radius: 999px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
        }
        .tab:hover {
            background: var(--accent-soft);
            border-color: transparent;
        }
        .tab.active {
            background: linear-gradient(135deg, var(--accent-soft), var(--alt-soft));
            border-color: transparent;
        }

        /* Main content */
        main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 16px;
            display: grid;
            gap: 16px;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 360px;
            gap: 16px;
        }
        @media (max-width: 980px) {
            .grid { grid-template-columns: 1fr; }
        }

        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            transition: var(--transition);
        }
        .card:hover {
            box-shadow: 0 12px 28px rgba(0,0,0,0.12);
        }

        .section-title {
            padding: 16px 16px 0;
            font-size: 18px;
            font-weight: 700;
        }

        /* Product grid */
        .products { padding: 16px; }
        .products-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            margin-bottom: 12px;
        }
        .input {
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 10px 12px;
            font-size: 14px;
            width: 260px;
            transition: var(--transition);
            background: var(--card);
            color: var(--text);
        }
        .input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px var(--accent-soft);
        }
        .select, .number {
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 10px 12px;
            font-size: 14px;
            background: var(--card);
            color: var(--text);
        }
        .btn {
            border: 1px solid var(--border);
            background: var(--card);
            padding: 10px 14px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .btn.primary {
            background: var(--accent);
            color: #fff;
            border-color: transparent;
        }
        .btn.primary:hover {
            background: #6d28d9;
        }
        .btn.turq {
            background: var(--alt);
            color: #003040;
            border-color: transparent;
        }
        .btn.turq:hover {
            background: #0891b2;
        }
        .btn.ghost {
            background: transparent;
        }
        .btn.icon {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        .catalog {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 12px;
        }

        .p-card {
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            transition: var(--transition);
        }
        .p-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.1);
        }
        .p-img {
            width: 100%;
            height: 160px;
            background: #f8fafc;
            border: 1px dashed var(--border);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .p-img img {
            width: 150px;
            height: 150px;
            object-fit: contain;
        }
        .p-name {
            font-weight: 700;
            font-size: 14px;
            min-height: 38px;
        }
        .p-prices { line-height: 1.1; }
        .p-bs { font-size: 20px; font-weight: 800; }
        .p-usd { font-size: 12px; color: var(--muted); }
        .qty-row { display: flex; gap: 8px; align-items: center; }
        .stepper {
            display: inline-flex;
            align-items: center;
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }
        .stepper button {
            border: none;
            background: #f8fafc;
            padding: 8px 10px;
            cursor: pointer;
            transition: var(--transition);
        }
        .stepper button:hover {
            background: #e5e7eb;
        }
        .stepper input {
            width: 56px;
            text-align: center;
            border: none;
            padding: 8px;
            font-weight: 700;
            background: var(--card);
            color: var(--text);
        }

        /* Cart */
        .cart {
            padding: 16px;
            position: sticky;
            top: 76px;
            height: fit-content;
        }
        .cart-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 8px;
            max-height: 400px;
            overflow-y: auto;
        }
        .cart-item {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 10px;
            transition: var(--transition);
        }
        .cart-item:hover {
            background: var(--accent-soft);
        }
        .cart-item h4 { margin: 0; font-size: 14px; }
        .cart-item .meta { font-size: 12px; color: var(--muted); }
        .cart-item .right { text-align: right; }
        .cart-summary {
            border-top: 1px dashed var(--border);
            padding-top: 12px;
            margin-top: 12px;
        }
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 999px;
            background: var(--accent-soft);
            color: #5b21b6;
            font-size: 12px;
            font-weight: 700;
        }

        /* Inventory */
        .flex {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: flex-end;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            text-align: left;
            padding: 10px;
            border-bottom: 1px solid var(--border);
            vertical-align: top;
        }
        th {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            color: var(--muted);
            position: sticky;
            top: 0;
            background: var(--card);
        }
        tbody tr:hover { background: var(--accent-soft); }

        .pill {
            padding: 2px 8px;
            border-radius: 999px;
            border: 1px solid var(--border);
            font-size: 12px;
        }

        /* Reports & Config */
        .kpi {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px,1fr));
            gap: 12px;
        }
        .kpi .box {
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 12px;
            background: var(--card);
        }
        .kpi .label { font-size: 12px; color: var(--muted); }
        .kpi .value { font-size: 22px; font-weight: 800; }

        .notice {
            padding: 10px 12px;
            border: 1px solid var(--border);
            background: var(--accent-soft);
            border-radius: 12px;
        }

        /* Hide/show sections */
        section { display: none; }
        section.active { display: block; }

        .footer {
            text-align: center;
            color: var(--muted);
            padding: 24px;
            font-size: 12px;
        }

        /* Toast notifications */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 16px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: var(--shadow);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 8px;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
        }
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        .toast.success {
            border-left: 4px solid var(--success);
        }
        .toast.error {
            border-left: 4px solid var(--danger);
        }
        .toast.warning {
            border-left: 4px solid var(--warning);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.4);
            z-index: 10;
            align-items: center;
            justify-content: center;
            padding: 16px;
            backdrop-filter: blur(4px);
        }
        .modal-content {
            max-width: 720px;
            width: 100%;
            padding: 16px;
            animation: modalFadeIn 0.3s ease;
        }
        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Image preview */
        .image-preview {
            width: 100%;
            height: 120px;
            border: 1px dashed var(--border);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            margin-bottom: 12px;
            position: relative;
        }
        .image-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        .remove-image {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        /* Modificación para que la imagen en la tabla se vea bien */
        .p-img-table {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .p-img-table img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Loading spinner */
        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(0,0,0,0.1);
            border-radius: 50%;
            border-top-color: var(--accent);
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Quagga scanner modal */
        #barcodeScannerModal .modal-content {
            max-width: 500px;
        }
        #interactive.viewport {
            position: relative;
            width: 100%;
            height: 300px;
            overflow: hidden;
            border-radius: 12px;
            border: 1px dashed var(--border);
        }
        #interactive.viewport video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
        }
        #interactive.viewport canvas {
            width: 100%;
            height: 100%;
            position: absolute;
            z-index: 2;
        }
        .drawingBuffer {
            position: absolute;
            top: 0;
            left: 0;
        }
    </style>
</head>
<body>
    <div id="toastContainer"></div>
    
    <header>
        <div class="wrap titlebar">
            <div class="brand"><span class="dot"></span> Sistema de Ventas & Inventario</div>
            <nav class="tabs">
                <button class="tab active" data-tab="ventas">Ventas</button>
                <button class="tab" data-tab="inventario">Inventario</button>
                <button class="tab" data-tab="reportes">Reportes</button>
                <button class="tab" data-tab="config">Configuración</button>
            </nav>
        </div>
    </header>

    <main>
        <section id="ventas" class="active">
            <div class="grid">
                <div class="card products">
                    <div class="products-toolbar">
                        <input id="searchVentas" class="input" placeholder="Buscar producto..." />
                        <span class="pill">Tipo de cambio: <b id="rateDisplay">—</b> Bs/USD</span>
                        <button id="btnBarcode" class="btn icon">Escanear código</button>
                    </div>
                    <div id="catalog" class="catalog"></div>
                </div>
                <aside class="card cart">
                    <div class="section-title">Carrito</div>
                    <div id="cartList" class="cart-list"></div>
                    <div class="cart-summary">
                        <div class="badge" id="cartCount">0 ítems</div>
                        <div style="margin-top:8px">
                            <div><b>Total Bs:</b> <span id="cartTotalBs">0</span></div>
                            <div class="p-usd"><b>Total USD:</b> <span id="cartTotalUsd">0</span></div>
                        </div>
                        <div style="display:flex; gap:8px; margin-top:12px;">
                            <button id="btnVaciar" class="btn">Vaciar</button>
                            <button id="btnCobrar" class="btn primary">Finalizar venta</button>
                        </div>
                    </div>
                </aside>
            </div>
        </section>

        <section id="inventario">
            <div class="card" style="padding:16px;">
                <div class="section-title">Productos</div>
                <div class="flex" style="margin-top:8px;">
                    <input id="searchInv" class="input" placeholder="Buscar en inventario..." />
                    <button id="btnNuevo" class="btn turq icon">Nuevo producto</button>
                    <button id="btnExport" class="btn icon">Exportar respaldo</button>
                    <label class="btn icon"><input type="file" id="fileImport" accept="application/json" style="display:none">Importar</label>
                </div>
                <div style="overflow:auto; margin-top:12px;">
                    <table>
                        <thead>
                            <tr>
                                <th></th>
                                <th>Producto</th>
                                <th>Precio unit. Bs / USD</th>
                                <th>Costos</th>
                                <th>Stock</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="invTable"></tbody>
                    </table>
                </div>
            </div>

            <div id="modal" class="modal">
                <div class="card modal-content">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div class="section-title" id="modalTitle">Nuevo producto</div>
                        <button id="modalClose" class="btn">Cerrar</button>
                    </div>
                    <form id="productForm" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap:12px; margin-top:8px;">
                        <input name="barcode" class="input" placeholder="Código de barras" style="width: 100%;" />
                        <div style="grid-column: 1 / -1;">
                            <div class="image-preview" id="imagePreview">
                                <span style="color:#9ca3af">Previsualización de imagen</span>
                            </div>
                            <input type="file" name="imageFile" accept="image/*" class="input" />
                        </div>
                        <input name="name" class="input" placeholder="Nombre" required style="width: 25ch;" />
                        <input name="category" class="input" placeholder="Categoría" list="categories" style="width: 15ch;" />
                        <datalist id="categories">
                            <option value="Alimentos">
                            <option value="Bebidas">
                            <option value="Limpieza">
                            <option value="Electrónica">
                        </datalist>
                        <input name="costBox" class="number" type="number" step="0.01" min="0" placeholder="Costo por caja (USD)" id="costBoxInput" required />
                        <input name="unitsBox" class="number" type="number" step="1" min="1" placeholder="Unidades por caja" id="unitsBoxInput" required />
                        <input name="margin" class="number" type="number" step="any" min="0" max="95" inputmode="decimal" placeholder="Margen (%)" required />
                        <input name="stockUnits" class="number" type="number" step="1" min="0" placeholder="Stock inicial (unidades)" id="stockUnitsInput" />
                        <div style="grid-column: 1 / -1; display:flex; gap:8px; justify-content:flex-end;">
                            <button type="button" class="btn" id="btnPreviewPrice">Previsualizar precios</button>
                            <button class="btn primary">Guardar</button>
                        </div>
                        <div id="pricePreview" class="notice" style="grid-column:1/-1; display:none;"></div>
                    </form>
                </div>
            </div>
        </section>

        <section id="reportes">
            <div class="card" style="padding:16px;">
                <div class="section-title">Reportes diarios</div>
                <div class="flex" style="margin-top:8px;">
                    <input id="repDate" type="date" class="input" />
                    <button id="btnHoy" class="btn">Hoy</button>
                    <button id="btnCSV" class="btn">Exportar CSV</button>
                    <button id="btnPDF" class="btn">Exportar PDF</button>
                </div>
                <div class="kpi" style="margin-top:12px;">
                    <div class="box"><div class="label">Ingresos (Bs)</div><div class="value" id="kpiIngresosBs">0</div></div>
                    <div class="box"><div class="label">Ingresos (USD)</div><div class="value" id="kpiIngresosUsd">0</div></div>
                    <div class="box"><div class="label">Ganancias (Bs)</div><div class="value" id="kpiGananciasBs">0</div></div>
                    <div class="box"><div class="label">Ganancias (USD)</div><div class="value" id="kpiGananciasUsd">0</div></div>
                    <div class="box"><div class="label">Capital en inventario (USD)</div><div class="value" id="kpiCapitalUsd">0</div></div>
                </div>
                <div style="margin-top:12px; overflow:auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Hora</th>
                                <th>Ítems</th>
                                <th>Total Bs</th>
                                <th>Total USD</th>
                                <th>Ganancia Bs</th>
                                <th>Ganancia USD</th>
                                <th>Tasa usada</th>
                            </tr>
                        </thead>
                        <tbody id="repTable"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="config">
            <div class="card" style="padding:16px;">
                <div class="section-title">Configuración</div>
                <div class="kpi" style="margin-top:8px;">
                    <div class="box">
                        <label>Tasa Bs/USD (diaria)</label>
                        <input id="cfgRate" type="number" class="number" step="0.01" min="0" placeholder="Ej: 40.00" />
                        <div style="margin-top:8px; display:flex; gap:8px;">
                            <button id="saveCfg" class="btn primary">Guardar</button>
                            <button id="resetDemo" class="btn">Cargar demo</button>
                            <button id="wipeAll" class="btn" style="color:var(--danger); border-color:var(--danger);">Borrar todo</button>
                        </div>
                    </div>
                </div>
                <div class="notice" style="margin-top:12px;">
                    <b>Privado y offline:</b> los datos se guardan en su navegador (localStorage). Use "Exportar respaldo" para guardar un archivo .json y "Importar" para restaurar.
                </div>
            </div>
        </section>
        
        <div id="barcodeScannerModal" class="modal">
            <div class="card modal-content">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div class="section-title">Escanear Producto</div>
                    <button id="barcodeScannerClose" class="btn">Cerrar</button>
                </div>
                <div style="margin-top:12px;">
                    <div id="interactive" class="viewport"></div>
                    <div id="scannerFeedback" style="text-align:center; padding:12px; color:var(--muted)">
                        Apunte la cámara a un código de barras.
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">Hecho para funcionar 100% offline con un solo archivo. Diseño claro con acentos morados/turquesa.</div>
    </main>

    <script src="https://unpkg.com/@ericblade/quagga2@1.8.2/dist/quagga.js"></script>

    <script>
        // ======================
        // Utilidades & Estado
        // ======================
        const $ = (sel, ctx=document) => ctx.querySelector(sel);
        const $$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));
        const fmt = new Intl.NumberFormat('es-VE', {maximumFractionDigits: 3});
        const fmtPrice = new Intl.NumberFormat('es-VE', {maximumFractionDigits: 2});
        const todayStr = () => new Date().toISOString().slice(0,10);

        // Mejorado: DB con validación y encriptación básica
        const DB = {
            get() {
                try {
                    const data = localStorage.getItem('appDB');
                    if (!data) return {}; // Desencriptación básica (mejorable con CryptoJS)
                    return JSON.parse(atob(data));
                } catch(e) {
                    console.error("Error al leer DB:", e);
                    return {};
                }
            },
            set(data) {
                try {
                    // Encriptación básica (mejorable con CryptoJS)
                    localStorage.setItem('appDB', btoa(JSON.stringify(data)));
                } catch(e) {
                    console.error("Error al guardar DB:", e);
                    showToast("Error al guardar datos", "error");
                }
            },
            patch(p) {
                const d = DB.get();
                DB.set({...d, ...p});
            },
            wipe() {
                localStorage.removeItem('appDB');
                showToast("Base de datos reiniciada", "success");
            }
        };

        // Sistema de notificaciones mejorado
        function showToast(message, type = "success") {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span>${message}</span>`;
            $('#toastContainer').appendChild(toast);
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Estructura inicial mejorada con categorías
        function initDB() {
            const d = DB.get();
            if (!d.products) d.products = [];
            if (!d.transactions) d.transactions = [];
            if (typeof d.rate !== 'number') d.rate = 0;
            if (!d.categories) d.categories = ["Alimentos", "Bebidas", "Limpieza", "Electrónica"];
            DB.set(d);
        }

        function uid() {
            return Math.random().toString(36).slice(2,9);
        }

        function calcUnitPricesUSD(p) {
            const costUnit = p.costBox / p.unitsBox;
            const priceUnit = costUnit / (1 - (p.margin / 100)); // USD
            const profitUnit = priceUnit - costUnit; // USD
            return { costUnit, priceUnit, profitUnit };
        }

        function bs(valUSD) {
            const rate = DB.get().rate;
            return rate ? valUSD * rate : 0;
        }
        
        function addProductToCart(product, qty = 1) {
            const d = DB.get();
            const p = d.products.find(x => x.id === product.id);
            if (!p) return;

            const prevQty = cart.get(p.id)?.qty || 0;
            if (prevQty + qty > p.stockUnits) {
                showToast(`No puede exceder el stock (${fmt.format(p.stockUnits)} u) en el carrito.`, "error");
                return;
            }

            cart.set(p.id, { qty: prevQty + qty });
            renderCart();
            showToast(`Añadido ${fmt.format(qty)} u de ${p.name}`);
        }

        // ======================
        // Tabs
        // ======================
        $$('.tab').forEach(t => t.addEventListener('click', () => {
            $$('.tab').forEach(x => x.classList.remove('active'));
            t.classList.add('active');
            const id = t.dataset.tab;
            $$('main section').forEach(s => s.classList.remove('active'));
            $('#'+id).classList.add('active');
            // Mejorado: Carga diferida de secciones
            switch(id) {
                case 'inventario': renderInventory(); break;
                case 'ventas': renderCatalog(); break;
                case 'reportes': renderReports(); break;
                case 'config': renderConfig(); break;
            }
        }));

        // ======================
        // Ventas / Catálogo
        // ======================
        const cart = new Map(); // key: productId, value: {qty}

        function renderCatalog() {
            const d = DB.get();
            $('#rateDisplay').textContent = d.rate ? fmt.format(d.rate) : 'Definir en Configuración';
            const q = ($('#searchVentas').value||'').toLowerCase().trim();
            const list = d.products.filter(p => p.name.toLowerCase().includes(q) || (p.barcode && p.barcode.includes(q)));
            const el = $('#catalog');
            el.innerHTML = '';

            if (list.length === 0) {
                el.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:40px; color:var(--muted)">No se encontraron productos</div>';
                return;
            }

            list.forEach(p => {
                const {priceUnit} = calcUnitPricesUSD(p);
                const priceBs = bs(priceUnit);
                const card = document.createElement('div');
                card.className = 'p-card';
                card.innerHTML = `
                    <div class="p-img">${p.image?`<img src="${p.image}" alt="${p.name}">`:'<span style="color:#9ca3af">Sin imagen</span>'}</div>
                    <div class="p-name">${p.name}</div>
                    <div class="p-prices">
                        <div class="p-bs">Bs ${fmtPrice.format(priceBs)}</div>
                        <div class="p-usd">USD ${fmtPrice.format(priceUnit)}</div>
                    </div>
                    <div class="qty-row" style="margin-top:4px;">
                        <div class="stepper">
                            <button class="minus" data-id="${p.id}" data-action="minus">-</button>
                            <input type="number" class="number" value="1" min="1" max="${p.stockUnits}" data-id="${p.id}" data-action="qty"/>
                            <button class="plus" data-id="${p.id}" data-action="plus">+</button>
                        </div>
                        <button class="btn primary" data-id="${p.id}" data-action="add-cart">Añadir</button>
                    </div>
                `;
                el.appendChild(card);
            });
        }

        function renderCart() {
            const d = DB.get();
            const listEl = $('#cartList');
            listEl.innerHTML='';
            let totalUsd = 0;
            let totalItems = 0;
            let totalProfitUsd = 0;

            if (cart.size === 0) {
                listEl.innerHTML = '<div style="text-align:center; padding:20px; color:var(--muted)">El carrito está vacío</div>';
            } else {
                cart.forEach((v, id) => {
                    const p = d.products.find(x => x.id === id);
                    if (!p) return;

                    const {priceUnit, profitUnit} = calcUnitPricesUSD(p);
                    const subUsd = priceUnit * v.qty;
                    const subProfitUsd = profitUnit * v.qty;
                    
                    totalUsd += subUsd;
                    totalItems += 1;
                    totalProfitUsd += subProfitUsd;

                    const itemEl = document.createElement('div');
                    itemEl.className = 'cart-item';
                    itemEl.innerHTML = `
                        <div>
                            <h4>${p.name}</h4>
                            <div class="meta">${v.qty} u x USD ${fmtPrice.format(priceUnit)}</div>
                        </div>
                        <div class="right">
                            <h4 style="color:var(--accent);"><b>Bs ${fmtPrice.format(bs(subUsd))}</b></h4>
                            <div class="meta">USD ${fmtPrice.format(subUsd)}</div>
                            <button class="btn ghost" data-id="${p.id}">Eliminar</button>
                        </div>
                    `;
                    listEl.appendChild(itemEl);
                });
            }

            $('#cartCount').textContent = `${totalItems} ítems`;
            $('#cartTotalUsd').textContent = fmtPrice.format(totalUsd);
            $('#cartTotalBs').textContent = fmtPrice.format(bs(totalUsd));
            $('#btnCobrar').disabled = cart.size === 0;
            $('#btnVaciar').disabled = cart.size === 0;
        }

        $('#cartList').addEventListener('click', (ev) => {
            const btn = ev.target.closest('[data-id]');
            if (btn) {
                cart.delete(btn.dataset.id);
                renderCart();
            }
        });
        
        $('#catalog').addEventListener('click', (ev) => {
            const btn = ev.target.closest('[data-action]');
            if (!btn) return;
            const id = btn.dataset.id;
            const action = btn.dataset.action;
            const d = DB.get();
            const p = d.products.find(x => x.id === id);
            if (!p) return;

            const qtyInput = $(`input[data-id="${id}"][data-action="qty"]`);
            let qty = parseInt(qtyInput.value) || 0;

            if (action === 'plus') {
                if (qty < p.stockUnits) qtyInput.value = qty + 1;
            } else if (action === 'minus') {
                if (qty > 1) qtyInput.value = qty - 1;
            } else if (action === 'add-cart') {
                addProductToCart(p, qty);
            }
        });

        $('#btnVaciar').addEventListener('click', () => {
            cart.clear();
            renderCart();
        });

        $('#btnCobrar').addEventListener('click', () => {
            const d = DB.get();
            if (!d.rate) {
                showToast("Debe definir una tasa Bs/USD en Configuración.", "error");
                return;
            }
            if (cart.size === 0) return;

            const items = [];
            let totalUsd = 0;
            let totalProfitUsd = 0;

            cart.forEach((v, id) => {
                const p = d.products.find(x => x.id === id);
                if (!p) return;
                const {priceUnit, profitUnit, costUnit} = calcUnitPricesUSD(p);
                const subUsd = priceUnit * v.qty;
                const subProfitUsd = profitUnit * v.qty;

                items.push({
                    name: p.name,
                    qty: v.qty,
                    priceUnit,
                    costUnit,
                    subTotalUsd: subUsd,
                    subProfitUsd: subProfitUsd
                });

                totalUsd += subUsd;
                totalProfitUsd += subProfitUsd;

                // Actualizar stock
                p.stockUnits -= v.qty;
            });

            d.transactions.push({
                id: uid(),
                date: todayStr(),
                timestamp: Date.now(),
                totalUsd,
                totalProfitUsd,
                rate: d.rate,
                items
            });

            DB.set(d);
            cart.clear();
            renderCart();
            renderInventory(); // Para que el stock se actualice visualmente
            showToast("Venta finalizada exitosamente.", "success");
        });

        $('#searchVentas').addEventListener('input', renderCatalog);

        // ======================
        // Inventario
        // ======================
        function renderInventory() {
            const d = DB.get();
            const q = ($('#searchInv').value || '').toLowerCase().trim();
            const list = d.products.filter(p => p.name.toLowerCase().includes(q) || (p.barcode && p.barcode.includes(q)));
            const el = $('#invTable');
            el.innerHTML = '';
            list.forEach(p => {
                const {priceUnit, costUnit} = calcUnitPricesUSD(p);
                const priceBs = bs(priceUnit);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div class="p-img-table">
                            ${p.image ? `<img src="${p.image}" alt="${p.name}">` : '<span style="color:#9ca3af; font-size:10px;">Sin imagen</span>'}
                        </div>
                    </td>
                    <td>
                        <div style="font-weight:700;">${p.name}</div>
                        <div style="font-size:12px; color:var(--muted);">${p.category}</div>
                        <div style="font-size:12px; color:var(--muted);">${p.barcode ? `<b>Código:</b> ${p.barcode}` : 'Sin código'}</div>
                    </td>
                    <td>
                        <div><b>Bs ${fmtPrice.format(priceBs)}</b></div>
                        <div style="font-size:12px; color:var(--muted);">USD ${fmtPrice.format(priceUnit)}</div>
                    </td>
                    <td>
                        <div><b>Costo:</b> USD ${fmtPrice.format(costUnit)}</div>
                        <div style="font-size:12px; color:var(--muted);"><b>Margen:</b> ${p.margin}%</div>
                    </td>
                    <td>
                        <div class="pill">Stock: ${p.stockUnits} u</div>
                    </td>
                    <td>
                        <button class="btn icon" data-id="${p.id}" data-action="add-unit-inv">Añadir 1 u.</button>
                        <button class="btn icon primary" data-id="${p.id}" data-action="add-box-inv">Añadir 1 c.</button>
                        <button class="btn icon" data-id="${p.id}" data-action="edit">Editar</button>
                        <button class="btn icon" data-id="${p.id}" data-action="delete" style="color:var(--danger); border-color:var(--danger)">Eliminar</button>
                    </td>
                `;
                el.appendChild(row);
            });
        }

        $('#invTable').addEventListener('click', (ev) => {
            const btn = ev.target.closest('[data-action]');
            if (!btn) return;
            const id = btn.dataset.id;
            const action = btn.dataset.action;
            
            const d = DB.get();
            const p = d.products.find(x => x.id === id);
            if (!p) return;

            if (action === 'edit') {
                openModal(id);
            } else if (action === 'delete') {
                if (confirm('¿Está seguro de eliminar este producto?')) {
                    d.products = d.products.filter(p => p.id !== id);
                    DB.set(d);
                    renderInventory();
                    showToast("Producto eliminado", "success");
                }
            } else if (action === 'add-unit-inv') {
                p.stockUnits += 1;
                DB.set(d);
                renderInventory();
                showToast(`Se ha añadido 1 unidad de ${p.name}`);
            } else if (action === 'add-box-inv') {
                p.stockUnits += p.unitsBox;
                DB.set(d);
                renderInventory();
                showToast(`Se ha añadido 1 caja de ${p.name} (${p.unitsBox} u)`);
            }
        });

        $('#searchInv').addEventListener('input', renderInventory);
        $('#btnNuevo').addEventListener('click', () => openModal());

        // ======================
        // Modal de Producto
        // ======================
        const modal = $('#modal');
        const form = $('#productForm');
        let currentProductId = null;

        function openModal(id = null) {
            currentProductId = id;
            form.reset();
            const d = DB.get();
            $('#modalTitle').textContent = id ? 'Editar producto' : 'Nuevo producto';
            $('#imagePreview').innerHTML = '<span style="color:#9ca3af">Previsualización de imagen</span>';
            
            // Llenar datalist de categorías
            const categoriesDatalist = $('#categories');
            categoriesDatalist.innerHTML = d.categories.map(c => `<option value="${c}">`).join('');

            if (id) {
                const p = d.products.find(x => x.id === id);
                if (p) {
                    $('[name="name"]').value = p.name;
                    $('[name="category"]').value = p.category;
                    $('[name="margin"]').value = p.margin;
                    $('[name="costBox"]').value = p.costBox;
                    $('[name="unitsBox"]').value = p.unitsBox;
                    $('[name="stockUnits"]').value = p.stockUnits;
                    $('[name="barcode"]').value = p.barcode || '';
                    if (p.image) {
                        $('#imagePreview').innerHTML = `<img src="${p.image}" alt="Preview"><button type="button" class="remove-image">×</button>`;
                    }
                }
            }
            modal.style.display = 'flex';
        }

        $('#modalClose').addEventListener('click', () => {
            modal.style.display = 'none';
        });

        $('#productForm').addEventListener('submit', (ev) => {
            ev.preventDefault();
            const d = DB.get();
            const form = ev.target;
            const data = {
                name: form.name.value,
                category: form.category.value,
                costBox: parseFloat(form.costBox.value),
                unitsBox: parseInt(form.unitsBox.value),
                margin: parseFloat(form.margin.value),
                stockUnits: parseInt(form.stockUnits.value),
                barcode: form.barcode.value.trim() || null,
                image: $('#imagePreview img')?.src || ''
            };

            if (currentProductId) {
                const index = d.products.findIndex(p => p.id === currentProductId);
                if (index !== -1) {
                    d.products[index] = {...d.products[index], ...data};
                }
            } else {
                data.id = uid();
                d.products.push(data);
            }

            // Actualizar datalist de categorías
            if (data.category && !d.categories.includes(data.category)) {
                d.categories.push(data.category);
            }

            DB.set(d);
            renderInventory();
            renderCatalog();
            modal.style.display = 'none';
            showToast("Producto guardado", "success");
        });
        
        $('#btnPreviewPrice').addEventListener('click', () => {
            const form = $('#productForm');
            const margin = parseFloat(form.margin.value);
            const costBox = parseFloat(form.costBox.value);
            const unitsBox = parseInt(form.unitsBox.value);
            
            if (isNaN(margin) || isNaN(costBox) || isNaN(unitsBox) || unitsBox <= 0) {
                 showToast("Por favor, ingrese todos los valores de costo y margen válidos", "error");
                 return;
            }

            const costUnit = costBox / unitsBox;
            const priceUnit = costUnit / (1 - (margin / 100));
            const priceBs = bs(priceUnit);
            
            const preview = $('#pricePreview');
            preview.innerHTML = `
                <b>Costo por unidad:</b> USD ${fmtPrice.format(costUnit)}<br>
                <b>Precio de venta:</b> USD ${fmtPrice.format(priceUnit)} (Bs ${fmtPrice.format(priceBs)})
            `;
            preview.style.display = 'block';
        });

        // ======================
        // Lógica de imágenes
        // ======================
        $('[name="imageFile"]').addEventListener('change', (ev) => {
            const file = ev.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const preview = $('#imagePreview');
                    preview.innerHTML = `<img src="${e.target.result}" alt="Preview"><button type="button" class="remove-image">×</button>`;
                    $('.remove-image', preview).addEventListener('click', () => {
                        $('[name="imageFile"]').value = '';
                        preview.innerHTML = '<span style="color:#9ca3af">Previsualización de imagen</span>';
                    });
                };
                reader.readAsDataURL(file);
            }
        });

        // ======================
        // Reportes
        // ======================
        function renderReports() {
            const d = DB.get();
            const date = $('#repDate').value || todayStr();
            const daily = d.transactions.filter(t => t.date === date);
            const el = $('#repTable');
            el.innerHTML = '';
            
            let ingresosBs = 0;
            let ingresosUsd = 0;
            let gananciasBs = 0;
            let gananciasUsd = 0;

            if (daily.length === 0) {
                el.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:20px; color:var(--muted)">No hay ventas para esta fecha</td></tr>';
            } else {
                daily.forEach(t => {
                    ingresosUsd += t.totalUsd;
                    gananciasUsd += t.totalProfitUsd;

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${new Date(t.timestamp).toLocaleTimeString()}</td>
                        <td>${t.items.length}</td>
                        <td>Bs ${fmtPrice.format(bs(t.totalUsd))}</td>
                        <td>USD ${fmtPrice.format(t.totalUsd)}</td>
                        <td>Bs ${fmtPrice.format(bs(t.totalProfitUsd))}</td>
                        <td>USD ${fmtPrice.format(t.totalProfitUsd)}</td>
                        <td>${fmtPrice.format(t.rate)}</td>
                    `;
                    el.appendChild(row);
                });
            }

            ingresosBs = bs(ingresosUsd);
            gananciasBs = bs(gananciasUsd);
            const capitalUsd = d.products.reduce((acc, p) => {
                const cost = (p.costBox / p.unitsBox) * p.stockUnits;
                return acc + (isNaN(cost) ? 0 : cost);
            }, 0);

            $('#kpiIngresosBs').textContent = fmtPrice.format(ingresosBs);
            $('#kpiIngresosUsd').textContent = fmtPrice.format(ingresosUsd);
            $('#kpiGananciasBs').textContent = fmtPrice.format(gananciasBs);
            $('#kpiGananciasUsd').textContent = fmtPrice.format(gananciasUsd);
            $('#kpiCapitalUsd').textContent = fmtPrice.format(capitalUsd);
        }

        $('#repDate').value = todayStr();
        $('#repDate').addEventListener('change', renderReports);
        $('#btnHoy').addEventListener('click', () => {
            $('#repDate').value = todayStr();
            renderReports();
        });

        // ======================
        // Config
        // ======================
        function renderConfig() {
            const d = DB.get();
            $('#cfgRate').value = d.rate || '';
        }

        $('#saveCfg').addEventListener('click', () => {
            const rate = parseFloat($('#cfgRate').value);
            if (!isNaN(rate)) {
                DB.patch({ rate });
                showToast("Tasa de cambio guardada", "success");
                renderCatalog();
                renderReports();
            } else {
                showToast("Por favor, ingrese una tasa válida", "error");
            }
        });

        $('#resetDemo').addEventListener('click', () => {
            if (confirm('¿Desea cargar datos de demostración? Esto borrará todos sus datos actuales.')) {
                DB.set({
                    rate: 40.00,
                    categories: ["Alimentos", "Bebidas"],
                    products: [
                        {
                            id: 'prod_cafe',
                            name: 'Café Molido 500g',
                            category: 'Alimentos',
                            costBox: 12.00,
                            unitsBox: 24,
                            margin: 30,
                            stockUnits: 40,
                            barcode: '759100010001'
                        },
                        {
                            id: 'prod_agua',
                            name: 'Agua mineral 1.5L',
                            category: 'Bebidas',
                            costBox: 5.00,
                            unitsBox: 12,
                            margin: 40,
                            stockUnits: 48,
                            barcode: '759100020002'
                        }
                    ],
                    transactions: []
                });
                renderInventory();
                renderCatalog();
                renderConfig();
                showToast("Datos de demostración cargados", "success");
            }
        });

        $('#wipeAll').addEventListener('click', () => {
            if (confirm('¿Está seguro de eliminar todos los datos de la aplicación? Esta acción es irreversible.')) {
                DB.wipe();
                initDB();
                renderInventory();
                renderCatalog();
                renderReports();
                renderConfig();
            }
        });

        // ======================
        // Exportar/Importar
        // ======================
        $('#btnExport').addEventListener('click', () => {
            const d = DB.get();
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(d));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", `respaldo-inventario-${todayStr()}.json`);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        });

        $('#fileImport').addEventListener('change', (ev) => {
            const file = ev.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.products && data.transactions) {
                        DB.set(data);
                        initDB();
                        renderInventory();
                        renderCatalog();
                        renderReports();
                        renderConfig();
                        showToast("Datos importados exitosamente", "success");
                    } else {
                        throw new Error("Formato de archivo inválido.");
                    }
                } catch (e) {
                    showToast("Error al importar el archivo. Asegúrese de que sea un JSON válido.", "error");
                }
            };
            reader.readAsText(file);
        });
        
        // ======================
        // Lector de código de barras
        // ======================
        let isScanning = false;
        const barcodeScannerModal = $('#barcodeScannerModal');
        const scannerFeedback = $('#scannerFeedback');

        function startScanner() {
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#interactive.viewport'),
                    constraints: {
                        width: { min: 480 },
                        height: { min: 300 },
                        facingMode: "environment" // Usa la cámara trasera en móviles
                    },
                },
                decoder: {
                    readers: ["ean_reader", "upc_reader", "code_128_reader"]
                }
            }, (err) => {
                if (err) {
                    console.error(err);
                    scannerFeedback.textContent = 'Error al iniciar la cámara. Asegúrese de tener permisos y una cámara disponible.';
                    return;
                }
                Quagga.start();
                isScanning = true;
                scannerFeedback.textContent = 'Apunte la cámara a un código de barras.';
            });
        
            Quagga.onDetected((result) => {
                if (isScanning) {
                    const barcode = result.codeResult.code;
                    const d = DB.get();
                    const product = d.products.find(p => p.barcode === barcode);
                    if (product) {
                        addProductToCart(product);
                        scannerFeedback.textContent = `Producto encontrado: ${product.name}`;
                        // Opcional: detener el escáner automáticamente después de encontrar el producto
                        // stopScanner(); 
                        // barcodeScannerModal.style.display = 'none';
                    } else {
                        scannerFeedback.textContent = `Código "${barcode}" no encontrado. Intente de nuevo.`;
                    }
                }
            });
        }
        
        function stopScanner() {
            Quagga.stop();
            isScanning = false;
        }

        $('#btnBarcode').addEventListener('click', () => {
            barcodeScannerModal.style.display = 'flex';
            startScanner();
        });

        $('#barcodeScannerClose').addEventListener('click', () => {
            stopScanner();
            barcodeScannerModal.style.display = 'none';
        });

        // Escaneo con teclado (para lectores USB)
        let barcodeBuffer = '';
        document.addEventListener('keydown', (e) => {
            // Ignorar eventos cuando el modal de escaneo está abierto o estamos escribiendo en un input
            if (barcodeScannerModal.style.display === 'flex' || document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA') {
                return;
            }

            // Los lectores de códigos de barras envían una secuencia rápida de caracteres
            // y terminan con Enter.
            if (e.key === 'Enter') {
                if (barcodeBuffer.length > 3) {
                    const d = DB.get();
                    const product = d.products.find(p => p.barcode === barcodeBuffer);
                    if (product) {
                        addProductToCart(product);
                    } else {
                        showToast(`Código de barras "${barcodeBuffer}" no encontrado.`, 'warning');
                    }
                }
                barcodeBuffer = '';
            } else {
                barcodeBuffer += e.key;
            }

            // Limpiar el buffer si el usuario no sigue escribiendo
            setTimeout(() => {
                barcodeBuffer = '';
            }, 500); // 500ms es un tiempo de espera razonable
        });

        // Initial setup
        initDB();
        renderCatalog();
        renderInventory();
        renderReports();
    </script>
</body>
</html>
